name: Go Multi-Platform Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*' # Trigger on version tags like v1.0.0
  pull_request:
    branches:
      - main

env:
  GO_VERSION: '1.25'
  APP_NAME: 'cdisc-proxy'

jobs:
  build:
    name: Build for Multiple Platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Windows
          - goos: windows
            goarch: amd64
            output: cdisc-proxy-windows-amd64.exe
          - goos: windows
            goarch: arm64
            output: cdisc-proxy-windows-arm64.exe
          
          # macOS
          - goos: darwin
            goarch: amd64
            output: cdisc-proxy-darwin-amd64
          - goos: darwin
            goarch: arm64
            output: cdisc-proxy-darwin-arm64
          
          # Linux
          - goos: linux
            goarch: amd64
            output: cdisc-proxy-linux-amd64
          - goos: linux
            goarch: arm64
            output: cdisc-proxy-linux-arm64
          - goos: linux
            goarch: arm
            goarm: '6'
            output: cdisc-proxy-linux-armv6
          
          # FreeBSD
          - goos: freebsd
            goarch: amd64
            output: cdisc-proxy-freebsd-amd64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build Binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          go build -ldflags="-s -w" -o ${{ matrix.output }}

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}

  package-deb:
    name: Create Debian/Ubuntu Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Linux AMD64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-linux-amd64

      - name: Extract Version from Tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create DEB Package Structure
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p package/usr/local/bin
          mkdir -p package/DEBIAN
          
          # Move binary
          chmod +x cdisc-proxy-linux-amd64
          mv cdisc-proxy-linux-amd64 package/usr/local/bin/cdisc-proxy
          
          # Create control file
          cat > package/DEBIAN/control << EOF
          Package: cdisc-proxy
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: CDISC Proxy <https://github.com/tomhub/cdisc-proxy>
          Description: CDISC Library API Proxy Server
           A proxy server for CDISC Library API operations
          EOF
          
          # Build the package
          dpkg-deb --build package cdisc-proxy_${VERSION}_amd64.deb

      - name: Upload DEB Package
        uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-deb
          path: cdisc-proxy_*.deb

  package-rpm:
    name: Create RPM Package (Fedora/RHEL/CentOS)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Linux AMD64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-linux-amd64

      - name: Extract Version from Tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install RPM Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Create RPM Package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p package/usr/local/bin
          
          # Move binary
          chmod +x cdisc-proxy-linux-amd64
          mv cdisc-proxy-linux-amd64 package/usr/local/bin/cdisc-proxy
          
          # Create tarball
          tar czf ~/rpmbuild/SOURCES/cdisc-proxy-${VERSION}.tar.gz -C package .
          
          # Create spec file
          cat > ~/rpmbuild/SPECS/cdisc-proxy.spec << EOF
          Name:           cdisc-proxy
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        CDISC Library API Proxy Server
          License:        MIT
          URL:            https://github.com/tomhub/cdisc-proxy
          Source0:        %{name}-%{version}.tar.gz

          %description
          A proxy server for CDISC Library API operations

          %prep
          %setup -q -c

          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp usr/local/bin/cdisc-proxy %{buildroot}/usr/local/bin/

          %files
          /usr/local/bin/cdisc-proxy

          %changelog
          * $(date +"%a %b %d %Y") CDISC Proxy Team <https://github.com/tomhub/cdisc-proxy> - ${VERSION}-1
          - Release ${VERSION}
          EOF
          
          # Build RPM
          rpmbuild -ba ~/rpmbuild/SPECS/cdisc-proxy.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm ./

      - name: Upload RPM Package
        uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-rpm
          path: '*.rpm'

  package-macos:
    name: Create macOS Package
    runs-on: macos-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download macOS ARM64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-darwin-arm64

      - name: Download macOS AMD64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-darwin-amd64

      - name: Extract Version from Tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create Universal Binary
        run: |
          chmod +x cdisc-proxy-darwin-arm64 cdisc-proxy-darwin-amd64
          lipo -create -output cdisc-proxy cdisc-proxy-darwin-arm64 cdisc-proxy-darwin-amd64

      - name: Create macOS PKG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p package/usr/local/bin
          cp cdisc-proxy package/usr/local/bin/
          chmod +x package/usr/local/bin/cdisc-proxy
          
          pkgbuild --root package \
                   --identifier com.github.tomhub.cdisc-proxy \
                   --version $VERSION \
                   --install-location / \
                   cdisc-proxy-${VERSION}-universal.pkg

      - name: Upload macOS Package
        uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-macos-pkg
          path: cdisc-proxy-*-universal.pkg

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, package-deb, package-rpm, package-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
