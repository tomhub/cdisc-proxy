name: Rust Multi-Platform Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  APP_NAME: cdisc-proxy
  RUST_VERSION: stable

jobs:
  build:
    name: Build for Multiple Platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Windows
          - target: x86_64-pc-windows-msvc
            output: cdisc-proxy-windows-amd64.exe
          - target: aarch64-pc-windows-msvc
            output: cdisc-proxy-windows-arm64.exe

          # macOS
          - target: x86_64-apple-darwin
            output: cdisc-proxy-darwin-amd64
          - target: aarch64-apple-darwin
            output: cdisc-proxy-darwin-arm64

          # Linux
          - target: x86_64-unknown-linux-gnu
            output: cdisc-proxy-linux-amd64
          - target: aarch64-unknown-linux-gnu
            output: cdisc-proxy-linux-arm64
          - target: armv6-unknown-linux-gnueabihf
            output: cdisc-proxy-linux-armv6

          # FreeBSD
          - target: x86_64-unknown-freebsd
            output: cdisc-proxy-freebsd-amd64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.target }}

      - name: Build Binary
        run: |
          cargo build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ env.APP_NAME }}* ${{ matrix.output }}

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}

  package-deb:
    name: Create Debian/Ubuntu Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-linux-amd64

      - name: Extract Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build DEB Package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p package/usr/local/bin package/DEBIAN

          chmod +x cdisc-proxy-linux-amd64
          mv cdisc-proxy-linux-amd64 package/usr/local/bin/cdisc-proxy

          cat > package/DEBIAN/control << EOF
          Package: cdisc-proxy
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: CDISC Proxy <https://github.com/tomhub/cdisc-proxy>
          Description: CDISC Library API Proxy Server
           A proxy server for CDISC Library API operations
          EOF

          dpkg-deb --build package cdisc-proxy_${VERSION}_amd64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-deb
          path: cdisc-proxy_*.deb

  package-rpm:
    name: Create RPM Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 Binary
        uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-linux-amd64

      - name: Extract Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            RPM_VERSION="$VERSION"
          else
            VERSION="0.0.0-dev"
            RPM_VERSION="0.0.0~dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rpm_version=$RPM_VERSION" >> $GITHUB_OUTPUT

      - name: Install RPM Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build RPM Package
        run: |
          VERSION="${{ steps.version.outputs.rpm_version }}"
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p package/usr/local/bin

          chmod +x cdisc-proxy-linux-amd64
          mv cdisc-proxy-linux-amd64 package/usr/local/bin/cdisc-proxy

          tar czf ~/rpmbuild/SOURCES/cdisc-proxy-${VERSION}.tar.gz -C package .

          cat > ~/rpmbuild/SPECS/cdisc-proxy.spec << EOF
          Name:           cdisc-proxy
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        CDISC Library API Proxy Server
          License:        MIT
          URL:            https://github.com/tomhub/cdisc-proxy
          Source0:        %{name}-%{version}.tar.gz

          %description
          A proxy server for CDISC Library API operations

          %prep
          %setup -q -c

          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp usr/local/bin/cdisc-proxy %{buildroot}/usr/local/bin/

          %files
          /usr/local/bin/cdisc-proxy

          %changelog
          * $(date +"%a %b %d %Y") CDISC Proxy Team - ${VERSION}-1
          - Release ${VERSION}
          EOF

          rpmbuild -ba ~/rpmbuild/SPECS/cdisc-proxy.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm ./

      - uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-rpm
          path: '*.rpm'

  package-macos:
    name: Create macOS Package
    runs-on: macos-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-darwin-arm64

      - uses: actions/download-artifact@v4
        with:
          name: cdisc-proxy-darwin-amd64

      - name: Extract Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Universal Binary
        run: |
          chmod +x cdisc-proxy-darwin-arm64 cdisc-proxy-darwin-amd64
          lipo -create -output cdisc-proxy cdisc-proxy-darwin-arm64 cdisc-proxy-darwin-amd64

      - name: Build macOS PKG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p package/usr/local/bin
          cp cdisc-proxy package/usr/local/bin/
          chmod +x package/usr/local/bin/cdisc-proxy

          pkgbuild --root package \
                   --identifier com.github.tomhub.cdisc-proxy \
                   --version $VERSION \
                   --install-location / \
                   cdisc-proxy-${VERSION}-universal.pkg

      - uses: actions/upload-artifact@v4
        with:
          name: cdisc-proxy-macos-pkg
          path: cdisc-proxy-*-universal.pkg

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, package-deb, package-rpm, package-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
