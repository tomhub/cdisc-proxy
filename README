# CDISC Library API Proxy Server

A high-performance caching proxy for the CDISC Library API with persistent storage in Valkey/Redis.

## Features

- **Transparent Caching**: Automatically caches successful API responses for 1 year
- **Forced Refresh**: Protected endpoint to force-refresh cached data
- **Authentication**: Bearer token authentication for the refresh endpoint
- **Health Checks**: Built-in health check endpoint
- **Configuration**: External YAML configuration file

## Prerequisites

- Go 1.21 or later
- Valkey or Redis server
- CDISC Library API key

## Installation

1. Clone or download the project files

2. Initialize Go module:
```bash
go mod init cdisc-proxy
```

3. Install dependencies:
```bash
go get github.com/valkey-io/valkey-go
go get gopkg.in/yaml.v3
```

4. Build the application:
```bash
go build -o cdisc-proxy main.go
```

## Configuration

1. Create the configuration directory (if using default location):
```bash
sudo mkdir -p /etc/conf.d
```

2. Copy the configuration file:
```bash
# For system-wide installation
sudo cp config.yaml /etc/conf.d/cdisc-proxy.conf

# Or keep it local for development
cp config.yaml my-config.yaml
```

3. Edit the configuration file and set:
   - **Server Port**: The port your proxy will listen on (default: 8080)
   - **Listen Addresses**: IP addresses to bind to (IPv4 and/or IPv6)
     - Leave empty or set to `["0.0.0.0", "::"]` to listen on all interfaces
     - Set to `["127.0.0.1", "::1"]` for localhost only
     - Specify exact IPs for production security
   - **Auth Key**: Generate a secure key for the refresh endpoint:
     ```bash
     openssl rand -hex 32
     ```
   - **CDISC API Key**: Your CDISC Library API key
   - **Valkey Connection**: Your Valkey/Redis server details
   - **Cache TTL**: How long to cache responses (default: 1 year)
     - Supports formats: `24h`, `7d`, `1y`, `2w`, etc.

## Running

Start the server with default config location (`/etc/conf.d/cdisc-proxy.conf`):
```bash
./cdisc-proxy
```

Or specify a custom config file:
```bash
./cdisc-proxy /path/to/config.yaml
```

The server will log which configuration file it's loading and which addresses it's listening on.

## API Usage

### 1. Regular Proxy Requests

Make requests to `/api/*` to proxy through to the CDISC Library API. The proxy will cache successful responses automatically.

**Example:**
```bash
# Get SDTM Implementation Guide
curl http://localhost:8080/api/mdr/sdtm/products/sdtmig/3-4

# The first request fetches from CDISC and caches (X-Cache: MISS)
# Subsequent requests serve from cache (X-Cache: HIT)
```

### 2. Force Refresh

Force fetch fresh data from CDISC and update the cache using the `/refresh` endpoint:

**Example:**
```bash
curl -X POST http://localhost:8080/refresh \
  -H "Authorization: Bearer your-auth-key-here" \
  -H "Content-Type: application/json" \
  -d '{"path": "/mdr/sdtm/products/sdtmig/3-4"}'
```

**Response:**
```json
{
  "status": "success",
  "cached": true,
  "status_code": 200,
  "content_size": 12345
}
```

### 3. Health Check

Check if the service is running and can connect to Valkey:

```bash
curl http://localhost:8080/health
```

**Response:**
```json
{
  "status": "healthy"
}
```

## Security Considerations

1. **Protect Your Auth Key**: Keep the `auth_key` in `config.yaml` secret
2. **Use HTTPS**: In production, run behind a reverse proxy with SSL/TLS (nginx, Caddy, etc.)
3. **Network Security**: Restrict access to the refresh endpoint or run behind a firewall
4. **Rotate Keys**: Periodically rotate your auth key and CDISC API key

## Cache Management

- **TTL**: Configurable in `config.yaml` (default: 1 year)
  - Use custom formats: `1y` (1 year), `30d` (30 days), `2w` (2 weeks)
  - Use Go duration format: `24h`, `720h`, `168h`
- **Key Format**: `cdisc:cache:<path>`
- **Manual Invalidation**: Use the `/refresh` endpoint or directly delete keys from Valkey/Redis

To manually inspect cache:
```bash
# Connect to Valkey
redis-cli

# List all cached keys
KEYS cdisc:cache:*

# View a specific cached response
GET "cdisc:cache:/mdr/sdtm/products/sdtmig/3-4"

# Delete a specific cache entry
DEL "cdisc:cache:/mdr/sdtm/products/sdtmig/3-4"
```

## Monitoring

The application logs:
- Cache hits/misses
- Errors (cache, CDISC API, etc.)
- Refresh requests

Example log output:
```
2025/11/16 10:00:00 Loading configuration from: /etc/conf.d/cdisc-proxy.conf
2025/11/16 10:00:00 Cache TTL set to: 8760h0m0s
2025/11/16 10:00:00 Starting CDISC Library API Proxy on port 8080
2025/11/16 10:00:00 Listening on: [0.0.0.0 ::]
2025/11/16 10:00:00 Proxy endpoint: /api/*
2025/11/16 10:00:00 Refresh endpoint: POST /refresh (requires authentication)
2025/11/16 10:00:00 Health check: /health
2025/11/16 10:00:00 Starting listener on 0.0.0.0:8080
2025/11/16 10:00:00 Starting listener on [::]:8080
2025/11/16 10:00:05 Cache miss for: /mdr/sdtm/products/sdtmig/3-4
2025/11/16 10:00:06 Cache hit for: /mdr/sdtm/products/sdtmig/3-4
2025/11/16 10:05:00 Refresh requested for: /mdr/sdtm/products/sdtmig/3-4
```

## Deployment

### Docker Example

Create a `Dockerfile`:
```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go mod download
RUN go build -o cdisc-proxy main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/cdisc-proxy .
COPY config.yaml .
EXPOSE 8080
CMD ["./cdisc-proxy"]
```

Build and run:
```bash
docker build -t cdisc-proxy .
docker run -p 8080:8080 -v $(pwd)/config.yaml:/root/config.yaml cdisc-proxy
```

### Systemd Service

Create `/etc/systemd/system/cdisc-proxy.service`:
```ini
[Unit]
Description=CDISC Library API Proxy
After=network.target

[Service]
Type=simple
User=cdisc
WorkingDirectory=/opt/cdisc-proxy
ExecStart=/opt/cdisc-proxy/cdisc-proxy
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Note: The service will automatically use `/etc/conf.d/cdisc-proxy.conf` when no config path is specified.

Enable and start:
```bash
sudo systemctl enable cdisc-proxy
sudo systemctl start cdisc-proxy
```

## Troubleshooting

**Issue**: "Failed to connect to Valkey"
- Solution: Check that Valkey/Redis is running and the address in config.yaml is correct

**Issue**: "Unauthorized" on refresh endpoint
- Solution: Verify the Authorization header includes the correct Bearer token

**Issue**: Slow responses
- Solution: Check network connectivity to CDISC API and Valkey server

## License

MIT License - feel free to use and modify as needed.
